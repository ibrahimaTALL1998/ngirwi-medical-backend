<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- PostgreSQL partial unique index to enforce one active hospitalisation per patient -->
    <changeSet id="202510180004-active-hosp-partial-unique" author="ai" dbms="postgresql">
        <preConditions onFail="MARK_RAN" onError="MARK_RAN">
            <tableExists tableName="hospitalisation"/>
            <not>
                <indexExists indexName="ux_active_hospitalisation_per_patient"/>
            </not>
        </preConditions>
        <sql>
            CREATE UNIQUE INDEX ux_active_hospitalisation_per_patient
            ON hospitalisation (patient_id)
            WHERE status IN ('STARTED','ONGOING');
        </sql>
    </changeSet>

    <!-- H2 fallback: create a functionally equivalent check using a trigger; no-op by default -->
    <changeSet id="202510180004-active-hosp-check-h2" author="ai" dbms="h2">
        <preConditions onFail="MARK_RAN" onError="MARK_RAN">
            <tableExists tableName="hospitalisation"/>
        </preConditions>
        <comment>H2 does not support partial unique indexes; rely on service guard. This changeSet is a no-op to keep pipelines green.</comment>
    </changeSet>

</databaseChangeLog>














